name: Manual SFTP Deployment

on:
  # Nur manuelles Deployment Ã¼ber GitHub Actions UI
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "deploy" to confirm deployment'
        required: true
        default: ''

jobs:
  deploy:
    name: Deploy Repository to Server via SFTP
    runs-on: ubuntu-latest
    
    steps:
      - name: Verify Confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "deploy" ]; then
            echo "âŒ Deployment cancelled. Please type 'deploy' to confirm."
            exit 1
          fi
          echo "âœ… Deployment confirmed"
      
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create Environment File with Secrets
        run: |
          # Erstelle .env Datei mit allen Secrets und Variablen
          cat > ./.env << EOF
          # Database Configuration
          DB_HOST=${{ secrets.DB_HOST }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          # SMTP Configuration
          SMTP_HOST=${{ secrets.SMTP_HOST }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_USER=${{ secrets.SMTP_USER }}
          SMTP_KEY=${{ secrets.SMTP_KEY }}
          
          # Site Configuration
          SITE_URL=${{ secrets.SITE_URL }}
          
          # SFTP Configuration (fÃ¼r Referenz)
          # SFTP_SERVER=${{ secrets.SFTP_SERVER }}
          # SFTP_USERNAME=${{ secrets.SFTP_USERNAME }}
          # SFTP_REMOTE_DIR=${{ secrets.SFTP_REMOTE_DIR }}
          
          # Debug Mode
          DEBUG_MODE=false
          EOF
          
          echo "âœ… Environment file created"
      
      - name: Prepare Deployment Package
        run: |
          echo "ðŸ“¦ Preparing deployment package..."
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          
      - name: Deploy via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.SFTP_SERVER }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT || 22 }}
          local_path: ./*
          remote_path: ${{ secrets.SFTP_REMOTE_DIR }}
          sftp_only: true
          delete_remote_files: false
          args: '-o ConnectTimeout=5'
      
      - name: Deployment Complete
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸ“ Server: ${{ secrets.SFTP_SERVER }}"
          echo "ðŸ“‚ Remote path: ${{ secrets.SFTP_REMOTE_DIR }}"
