name: Manual SFTP Deployment

on:
  # Nur manuelles Deployment √ºber GitHub Actions UI
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "deploy" to confirm deployment'
        required: true
        default: ''

jobs:
  deploy:
    name: Deploy Repository to Server via SFTP
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      - name: Verify Confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "deploy" ]; then
            echo "‚ùå Deployment cancelled. Please type 'deploy' to confirm."
            exit 1
          fi
          echo "‚úÖ Deployment confirmed"
      
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create Environment File with Secrets
        run: |
          # Erstelle .env Datei mit allen Secrets und Variablen
          cat > ./.env << 'EOF'
          # Database Configuration
          DB_HOST=${{ secrets.DB_HOST }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORT=${{ secrets.DB_PASSWORD }}
          
          # SMTP Configuration
          SMTP_HOST=${{ secrets.SMTP_HOST }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_USER=${{ secrets.SMTP_USER }}
          SMTP_KEY=${{ secrets.SMTP_KEY }}
          
          # Site Configuration
          SITE_URL=${{ secrets.SITE_URL }}
          
          # Debug Mode
          DEBUG_MODE=false
          EOF
          
          echo "‚úÖ Environment file created (secrets masked in logs)"
      
      - name: Prepare Deployment Package
        run: |
          echo "üì¶ Preparing deployment package..."
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          
      - name: Install sshpass for password authentication
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass rsync

      - name: Deploy via SFTP (Incremental with rsync)
        run: |
          echo "üöÄ Starting incremental deployment..."
          echo "Only changed files will be uploaded"

          # Erstelle SSH-Konfiguration f√ºr Host-Key-Akzeptanz
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SFTP_PORT != '' && secrets.SFTP_PORT || '22' }} ${{ secrets.SFTP_SERVER }} >> ~/.ssh/known_hosts 2>/dev/null

          # rsync √ºber SSH mit Passwort-Authentifizierung f√ºr inkrementelle Updates
          # Nur ge√§nderte, neue oder gel√∂schte Dateien werden √ºbertragen
          sshpass -p "${{ secrets.SFTP_PASSWORD }}" \
            rsync -avz --stats \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='node_modules/' \
            --exclude='.gitignore' \
            --exclude='.gitattributes' \
            --exclude='*.log' \
            --exclude='.DS_Store' \
            -e "ssh -p ${{ secrets.SFTP_PORT != '' && secrets.SFTP_PORT || '22' }} -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.SFTP_USERNAME }}@${{ secrets.SFTP_SERVER }}:${{ secrets.SFTP_REMOTE_DIR }}/

          echo "‚úÖ Incremental deployment completed - only modified files were uploaded"
      
      - name: Deployment Complete
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üìç Server: ${{ secrets.SFTP_SERVER }}"
          echo "üìÇ Remote path: ${{ secrets.SFTP_REMOTE_DIR }}"
